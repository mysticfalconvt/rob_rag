generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model AuthUser {
  id              String         @id @default(uuid())
  email           String         @unique
  name            String
  passwordHash    String
  role            String         @default("user")
  isActive        Boolean        @default(true)
  userName        String?
  userBio         String?
  userPreferences String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?
  conversations   Conversation[]
  uploadedFiles   IndexedFile[]
  sessions        Session[]

  @@index([email])
  @@index([role])
}

model Session {
  id         String   @id @default(uuid())
  userId     String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  lastActive DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  user       AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model IndexedFile {
  id                     String          @id @default(uuid())
  filePath               String          @unique
  fileHash               String
  lastModified           DateTime
  lastIndexed            DateTime        @default(now())
  chunkCount             Int
  status                 String          @default("indexed")
  source                 String          @default("local")
  uploadedBy             String?
  paperlessId            Int?
  paperlessTitle         String?
  paperlessTags          String?
  paperlessCorrespondent String?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  chunks                 DocumentChunk[]
  uploader               AuthUser?       @relation(fields: [uploadedBy], references: [id])

  @@index([uploadedBy])
  @@index([source])
  @@index([filePath])
}

model Conversation {
  id        String    @id @default(uuid())
  userId    String
  title     String
  topics    String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      AuthUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
  @@index([createdAt])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  role           String
  content        String
  sources        String?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model Settings {
  id                      String   @id @default("singleton")
  embeddingModel          String
  chatModel               String
  fastChatModel           String?
  embeddingModelDimension Int      @default(1024)
  paperlessUrl            String?
  paperlessExternalUrl    String?
  paperlessApiToken       String?
  paperlessEnabled        Boolean  @default(false)
  ragSystemPrompt         String?
  noSourcesSystemPrompt   String?
  titleGenerationPrompt   String?
  maxContextTokens        Int      @default(8000)
  contextStrategy         String   @default("smart")
  slidingWindowSize       Int      @default(10)
  enableContextSummary    Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

model GoodreadsUser {
  id               String           @id @default(uuid())
  name             String
  email            String?          @unique
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  goodreadsBooks   GoodreadsBook[]
  goodreadsSources GoodreadsSource?

  @@index([email])
}

model GoodreadsSource {
  id           String        @id @default(uuid())
  userId       String        @unique
  rssFeedUrl   String
  lastSyncedAt DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         GoodreadsUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model GoodreadsBook {
  id                String                 @id @default(uuid())
  userId            String
  goodreadsBookId   String
  title             String
  author            String
  additionalAuthors String?
  isbn              String?
  isbn13            String?
  userRating        Int?
  averageRating     Float?
  dateRead          DateTime?
  readDates         String?
  dateAdded         DateTime?
  shelves           String?
  reviewText        String?
  spoiler           Boolean                @default(false)
  privateNotes      String?
  pages             Int?
  yearPublished     Int?
  readCount         Int                    @default(1)
  imageUrl          String?
  embedding         Unsupported("vector")?
  embeddingVersion  Int?                   @default(1)
  lastEmbedded      DateTime?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  chunks            DocumentChunk[]
  user              GoodreadsUser          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, goodreadsBookId])
  @@index([userId])
  @@index([goodreadsBookId])
  @@index([userRating])
  @@index([dateRead])
}

model DocumentChunk {
  id                     String                @id @default(uuid())
  content                String
  embedding              Unsupported("vector")
  source                 String
  fileName               String
  filePath               String
  fileType               String?
  fileId                 String?
  bookId                 String?
  chunkIndex             Int
  totalChunks            Int
  userId                 String?
  userName               String?
  bookTitle              String?
  bookAuthor             String?
  userRating             Int?
  dateRead               String?
  readDates              String?
  readCount              Int?
  shelves                String?
  paperlessId            Int?
  paperlessTitle         String?
  paperlessTags          String?
  paperlessCorrespondent String?
  documentDate           String?
  embeddingVersion       Int                   @default(1)
  lastEmbedded           DateTime              @default(now())
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  book                   GoodreadsBook?        @relation(fields: [bookId], references: [id], onDelete: Cascade)
  file                   IndexedFile?          @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([source])
  @@index([filePath])
  @@index([fileId])
  @@index([bookId])
  @@index([userId])
  @@index([userRating])
  @@index([dateRead])
  @@index([paperlessId])
  @@index([embedding])
}

model LLMRequest {
  id                String     @id @default(uuid())
  conversationId    String?
  messageId         String?
  userId            String?
  requestType       String
  model             String
  promptTokens      Int
  completionTokens  Int
  totalTokens       Int
  duration          Int
  tokensPerSecond   Float
  requestPayload    String
  error             String?
  createdAt         DateTime   @default(now())
  calls             LLMCall[]

  @@index([conversationId])
  @@index([messageId])
  @@index([userId])
  @@index([requestType])
  @@index([model])
  @@index([createdAt])
}

model LLMCall {
  id              String     @id @default(uuid())
  requestId       String
  callType        String
  model           String
  promptTokens    Int
  completionTokens Int
  totalTokens     Int
  duration        Int
  tokensPerSecond Float
  callPayload     String?
  error           String?
  createdAt       DateTime   @default(now())
  request         LLMRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([callType])
  @@index([model])
  @@index([createdAt])
}
