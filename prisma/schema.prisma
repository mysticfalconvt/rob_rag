generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model AuthUser {
  id              String         @id @default(uuid())
  email           String         @unique
  name            String
  passwordHash    String
  role            String         @default("user")
  isActive        Boolean        @default(true)
  userName        String?
  userBio         String?
  userPreferences String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?
  conversations   Conversation[]
  uploadedFiles   IndexedFile[]
  sessions        Session[]

  @@index([email])
  @@index([role])
}

model Session {
  id         String   @id @default(uuid())
  userId     String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  lastActive DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  user       AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model IndexedFile {
  id                     String          @id @default(uuid())
  filePath               String          @unique
  fileHash               String
  lastModified           DateTime
  lastIndexed            DateTime        @default(now())
  chunkCount             Int
  status                 String          @default("indexed")
  source                 String          @default("local")
  uploadedBy             String?
  paperlessId            Int?
  paperlessTitle         String?
  paperlessTags          String?
  paperlessCorrespondent String?
  useCustomOcr           Boolean         @default(false)
  customOcrStatus        String?
  originalDocPath        String?
  ocrOutputPath          String?
  extractedDate          DateTime?
  extractedTags          String?
  documentType           String?
  documentSummary        String?
  sourceOverride         String?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  chunks                 DocumentChunk[]
  uploader               AuthUser?       @relation(fields: [uploadedBy], references: [id])

  @@index([uploadedBy])
  @@index([source])
  @@index([filePath])
  @@index([useCustomOcr])
  @@index([sourceOverride])
  documentTags DocumentTag[]
}

model Tag {
  id             String        @id @default(uuid())
  name           String        @unique
  status         String        @default("pending") // "pending" or "approved"
  color          String?       // Optional color for UI
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  documentTags   DocumentTag[]

  @@index([status])
  @@index([name])
}

model DocumentTag {
  id           String      @id @default(uuid())
  fileId       String
  tagId        String
  createdAt    DateTime    @default(now())
  file         IndexedFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  tag          Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([fileId, tagId])
  @@index([fileId])
  @@index([tagId])
}

model Conversation {
  id        String    @id @default(uuid())
  userId    String
  title     String
  topics    String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      AuthUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
  @@index([createdAt])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  role           String
  content        String
  sources        String?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model Settings {
  id                      String    @id @default("singleton")
  embeddingModel          String
  chatModel               String
  fastChatModel           String?
  visionModel             String?
  embeddingModelDimension Int       @default(1024)
  paperlessUrl            String?
  paperlessExternalUrl    String?
  paperlessApiToken       String?
  paperlessEnabled        Boolean   @default(false)
  customOcrEnabled        Boolean   @default(false)
  ragSystemPrompt         String?
  noSourcesSystemPrompt   String?
  titleGenerationPrompt   String?
  maxContextTokens        Int       @default(8000)
  contextStrategy         String    @default("smart")
  slidingWindowSize       Int       @default(10)
  enableContextSummary    Boolean   @default(true)
  googleClientId          String?
  googleClientSecret      String?
  googleRefreshToken      String?
  googleAccessToken       String?
  googleTokenExpiresAt    DateTime?
  googleCalendarIds       String?
  googleLastSynced        DateTime?
  googleSyncEnabled       Boolean   @default(false)
  syncedFilesConfig       String?   // JSON config for synced files filtering
  paperlessSyncEnabled    Boolean   @default(false)
  paperlessSyncInterval   Int       @default(60) // minutes
  paperlessSyncLastRun    DateTime?
  paperlessSyncFilters    String?   // JSON: tags, dateRange, etc.
  paperlessAutoOcr        Boolean   @default(false)
  // Matrix configuration
  matrixHomeserver        String?
  matrixAccessToken       String?
  matrixUserId            String?
  matrixEnabled           Boolean   @default(false)
  matrixAllowedUsers      String?   // JSON array of allowed Matrix user IDs
  // Sync schedules (cron expressions)
  googleCalendarSyncSchedule String? @default("0 0 * * *")  // Midnight daily
  paperlessSyncSchedule      String? @default("0 * * * *")  // Hourly
  goodreadsSyncSchedule      String? @default("0 2 * * *")  // 2am daily
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
}

model GoodreadsUser {
  id               String           @id @default(uuid())
  name             String
  email            String?          @unique
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  goodreadsBooks   GoodreadsBook[]
  goodreadsSources GoodreadsSource?

  @@index([email])
}

model GoodreadsSource {
  id           String        @id @default(uuid())
  userId       String        @unique
  rssFeedUrl   String
  lastSyncedAt DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         GoodreadsUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model OcrJob {
  id            String   @id @default(uuid())
  paperlessId   Int
  status        String   // pending, processing, completed, failed
  progress      Int      @default(0)
  error         String?
  visionModel   String
  createdAt     DateTime @default(now())
  startedAt     DateTime?
  completedAt   DateTime?
  updatedAt     DateTime @updatedAt

  @@index([paperlessId])
  @@index([status])
  @@index([createdAt])
}

model GoodreadsBook {
  id                String                 @id @default(uuid())
  userId            String
  goodreadsBookId   String
  title             String
  author            String
  additionalAuthors String?
  isbn              String?
  isbn13            String?
  userRating        Int?
  averageRating     Float?
  dateRead          DateTime?
  readDates         String?
  dateAdded         DateTime?
  shelves           String?
  reviewText        String?
  spoiler           Boolean                @default(false)
  privateNotes      String?
  pages             Int?
  yearPublished     Int?
  readCount         Int                    @default(1)
  imageUrl          String?
  embedding         Unsupported("vector")?
  embeddingVersion  Int?                   @default(1)
  lastEmbedded      DateTime?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  chunks            DocumentChunk[]
  user              GoodreadsUser          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, goodreadsBookId])
  @@index([userId])
  @@index([goodreadsBookId])
  @@index([userRating])
  @@index([dateRead])
}

model DocumentChunk {
  id                     String                @id @default(uuid())
  content                String
  embedding              Unsupported("vector")
  source                 String
  fileName               String
  filePath               String
  fileType               String?
  fileId                 String?
  bookId                 String?
  eventId                String?
  chunkIndex             Int
  totalChunks            Int
  chunkType              String?
  userId                 String?
  userName               String?
  bookTitle              String?
  bookAuthor             String?
  userRating             Int?
  dateRead               String?
  readDates              String?
  readCount              Int?
  shelves                String?
  paperlessId            Int?
  paperlessTitle         String?
  paperlessTags          String?
  paperlessCorrespondent String?
  documentDate           String?
  eventTitle             String?
  eventStartTime         String?
  eventEndTime           String?
  eventLocation          String?
  eventAttendees         String?
  calendarName           String?
  embeddingVersion       Int                   @default(1)
  lastEmbedded           DateTime              @default(now())
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  book                   GoodreadsBook?        @relation(fields: [bookId], references: [id], onDelete: Cascade)
  file                   IndexedFile?          @relation(fields: [fileId], references: [id], onDelete: Cascade)
  event                  CalendarEvent?        @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([source])
  @@index([filePath])
  @@index([fileId])
  @@index([bookId])
  @@index([eventId])
  @@index([userId])
  @@index([userRating])
  @@index([dateRead])
  @@index([paperlessId])
  @@index([embedding])
  @@index([chunkType])
}

model LLMRequest {
  id                String     @id @default(uuid())
  conversationId    String?
  messageId         String?
  userId            String?
  requestType       String
  model             String
  promptTokens      Int
  completionTokens  Int
  totalTokens       Int
  duration          Int
  tokensPerSecond   Float
  requestPayload    String
  error             String?
  createdAt         DateTime   @default(now())
  calls             LLMCall[]

  @@index([conversationId])
  @@index([messageId])
  @@index([userId])
  @@index([requestType])
  @@index([model])
  @@index([createdAt])
}

model LLMCall {
  id              String     @id @default(uuid())
  requestId       String
  callType        String
  model           String
  promptTokens    Int
  completionTokens Int
  totalTokens     Int
  duration        Int
  tokensPerSecond Float
  callPayload     String?
  error           String?
  createdAt       DateTime   @default(now())
  request         LLMRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([callType])
  @@index([model])
  @@index([createdAt])
}

model CalendarEvent {
  id          String                 @id @default(uuid())
  eventId     String                 @unique
  calendarId  String
  calendarName String?
  title       String
  description String?
  location    String?
  startTime   DateTime
  endTime     DateTime
  attendees   String?
  recurringEventId String?
  htmlLink    String?
  embedding   Unsupported("vector")?
  embeddingVersion Int?              @default(1)
  lastEmbedded DateTime?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  chunks      DocumentChunk[]

  @@index([eventId])
  @@index([calendarId])
  @@index([startTime])
  @@index([endTime])
  @@index([embedding])
}

model MatrixRoom {
  id          String   @id @default(uuid())
  roomId      String   @unique
  name        String
  description String?
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled])
  @@index([roomId])
}

model ScheduledTask {
  id              String          @id @default(uuid())
  type            String          // "matrix_reminder", "auto_sync"
  name            String
  schedule        String          // Cron expression
  enabled         Boolean         @default(true)
  query           String?         // For reminders: RAG query
  matrixRoomId    String?         // Target room for reminders
  syncSource      String?         // For syncs: "google-calendar", "paperless", "goodreads"
  lastRun         DateTime?
  lastRunStatus   String?         // "success", "failed", "skipped"
  lastRunError    String?         // Error message if failed
  nextRun         DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  executions      TaskExecution[]

  @@index([enabled, nextRun])
  @@index([type])
  @@index([syncSource])
}

model TaskExecution {
  id              String        @id @default(uuid())
  taskId          String
  status          String        // "success", "failed"
  startedAt       DateTime
  completedAt     DateTime?
  duration        Int?          // milliseconds
  error           String?
  response        String?       // Response sent to Matrix/logs
  metadata        String?       // JSON: room, query, result count, etc.
  task            ScheduledTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, startedAt])
  @@index([status])
  @@index([startedAt])
}
